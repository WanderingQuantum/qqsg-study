# 伤害计算

## 攻击结算

定义**一次攻击**为一方向另一方发起的在同一时间内造成一个或多个技能的伤害的行为，并称攻击发起方为**攻方**，受到攻击的一方为**目标**。

上述定义中的关键点为“同一时间内”，如130JS技能有先后的两段伤害，应看作两次攻击。

一次攻击的发起有且仅有三种情况：角色施放角色技能、元神主动攻击技能或奥义技能；触发元神反击类技能或经络反击类技能（黑熊探掌）；子女施放攻击技能。定义**主技能**为发起攻击的技能。

当主技能非子女攻击技能时，一次攻击的结算流程如下。

> - 结算经络灵兽技能
>   - 判定经络技能和灵兽技能的触发
>     - 若主技能为元神反击类技能或经络反击类技能，则不触发经络技能
>   - 计算经络灵兽技能总伤害，相应扣除目标血量，并显示总伤害数字
>   - 计算吸血值：$$吸血值=(经络灵兽最终伤害-破空伤害)*吸血百分比$$相应增加攻方血量，并显示吸血数字
>   - 结算荆棘
>     - 若不是致死伤害：$$荆棘伤害=(经络灵兽最终伤害-破空伤害)*(荆棘反伤百分比之和-荆棘抵抗百分比之和)$$相应扣除攻方血量，并显示伤害数字
>     - 若是致死伤害：$$荆棘伤害=0$$
>
> - 结算元神乱舞类技能
>   - 判定元神乱舞类技能的触发
>     - 若触发了经络技能，则不触发元神乱舞类技能
>   - 计算元神乱舞类技能伤害，相应扣除目标血量，并显示伤害数字
>   - 计算吸血值：$$吸血值=(元神乱舞类技能最终伤害-破空伤害)*吸血百分比$$相应增加攻方血量，并显示吸血数字
>   - 结算荆棘
>     - 若不是致死伤害：$$荆棘伤害=(元神乱舞类技能最终伤害-破空伤害)*(荆棘反伤百分比之和-荆棘抵抗百分比之和)$$相应扣除攻方血量，并显示伤害数字
>     - 若是致死伤害：$$荆棘伤害=0$$
>
> - 结算主技能伤害
>   - 计算主技能伤害，相应扣除目标血量，并显示伤害数字
>   - 计算吸血值：$$吸血值=(主技能最终伤害-破空伤害)*吸血百分比$$相应增加攻方血量，并显示吸血数字
>   - 结算荆棘
>     - 若不是致死伤害：$$荆棘伤害=(主技能最终伤害-破空伤害)*(荆棘反伤百分比之和-荆棘抵抗百分比之和)$$相应扣除攻方血量，并显示伤害数字
>     - 若是致死伤害：$$荆棘伤害=0$$
>
> - 结算新增状态

## 技能伤害计算

攻击结算中，技能伤害的计算按照下述公式进行。

$$
\begin{aligned}
对人伤害 = & (((基础伤害 \\
        & * (1 + 攻方灵魄类加成 - 目标灵魄类减伤 + 攻方抗性类加成 - 目标抗性类减伤 + 攻方普通加成修正 - 目标普通加成修正) + 500 * (攻方抗性类加成 - 目标抗性类减伤) + 杀戮额外伤害 + 三板斧额外伤害 + 被动心法额外伤害 - 被动心法伤害抵消) \\
        & * (1 + 攻方元神加成 * 攻方元神忠诚效果 - 目标元神减伤 * 目标元神忠诚效果 + 攻方元神加成修正 - 目标元神加成修正) + 元神加成额外伤害 * (攻方元神加成 * 攻方元神忠诚效果 - 目标元神减伤 * 目标元神忠诚效果)) \\
        & * (1 + 攻方八阵图四象加成 - 目标八阵图四象减伤) + 攻方装备额外伤害 - 目标装备伤害抵消) \\
        & * (1 + 连击加成 * (1 + 疾风剑侍快斩之意加成)) * (1 + 攻方夫妻加成) * (1 - 目标夫妻减伤) * (1 + 120技能对80技能的加成) * (1 - 形若坚冰减伤) * (1 - 卫心减伤) * \frac{1}{4} + 破空额外伤害
\end{aligned}
$$

$$
\begin{aligned}
对怪伤害 = & (((基础伤害 \\
        & * (1 + 攻方灵魄类加成 + 攻方抗性类加成 - 目标抗性类减伤 + 攻方普通加成修正) + 500 * (攻方抗性类加成 - 目标抗性类减伤) + 杀戮额外伤害 + 三板斧额外伤害 + 被动心法额外伤害) \\
        & * (1 + 攻方元神加成 * 攻方元神忠诚效果 - 目标元神减伤 + 攻方元神加成修正) + 元神加成额外伤害 * (攻方元神加成 * 攻方元神忠诚效果 - 目标元神减伤)) \\
        & * (1 + 对怪特殊加成) + 攻方装备额外伤害) \\
        & * (1 + 连击加成 * (1 + 疾风剑侍快斩之意加成)) * (1 + 攻方夫妻加成) * (1 + 120技能对80技能的加成) + 破空额外伤害
\end{aligned}
$$

### 基础伤害

定义**约化物防**和**约化法防**为
$$
约化物防 =
\begin{cases}
    目标物防+(目标体质-30)*3 \qquad & 攻方物攻<450 \\
    目标物防+(目标体质-30)*3-(攻方物攻-450)*2 \qquad & 攻方物攻\geq450
\end{cases}
$$
$$
约化法防 =
\begin{cases}
    目标法防+(目标智力-30)*3 \qquad & 攻方法攻<450 \\
    目标法防+(目标智力-30)*3-(攻方法攻-450)*2 \qquad & 攻方法攻\geq450
\end{cases}
$$
其中目标物防和目标法防受到破甲与减破的影响，具体计算见[破甲与减破](#破甲与减破)一节；目标体质和目标智力受到刮骨的影响，见[刮骨](#刮骨)一节。

约化物防和约化法防统称约化防御。

当攻方为物系时，
$$基础伤害=(技能系数*系数伤害+技能攻击力+附加伤害)*修正因子$$
其中
$$系数伤害=A*(1+攻方物攻/B)*(攻方武力-D)$$
$$
附加伤害=
\begin{cases}
    A \qquad & 攻方物攻<目标物防/2\ 且\ 攻方物攻<450 \\
    C(1+D*攻方物攻-E*目标物防+F*攻方物攻*目标物防)*(攻方武力-G)-B \qquad & 目标物防/2 \leq 攻方物攻 < 450 \\
    C(1+D*攻方物攻-E*目标物防+F*攻方物攻*目标物防)*(攻方武力-G) \qquad & 攻方物攻\geq450
\end{cases}
$$
$$
修正因子 =
\begin{cases}
    1-\frac{约化物防}{768} \qquad & 约化物防<651 \\
    \frac{51.5}{约化物防^{0.9}} \qquad & 约化物防\geq651
\end{cases}
$$

当攻方为法系时，
$$基础伤害=(技能系数*系数伤害+技能攻击力)*修正因子+附加伤害$$
其中
$$
系数伤害 =
\begin{cases}
    (A+B*攻方法攻-C*目标法防+D*攻方法攻*目标法防)^2*(E+F*攻方智力) \qquad & 攻方法攻<450 \\
    (G+H*攻方法攻)*(K+L*攻方智力) \qquad & 攻方法攻\geq450
\end{cases}
$$
$$附加伤害=-目标法防/3$$
$$
修正因子 =
\begin{cases}
    1-\frac{约化法防}{768} \qquad & 约化法防<651 \\
    \frac{51.5}{约化法防^{0.9}} \qquad & 约化法防\geq651
\end{cases}
$$

怪物的物攻、法攻、物防、法防、武力、智力、命中、灵活和体质是怪物的内置属性，见[原始解包数据](原始解包数据.md)中怪物数据表的L-P列和U-X列。

### 普通加成

定义**普通加成**为灵魄类加成/减伤和抗性类加成/减伤的统称。

灵魄类加成/减伤的来源见下表；

| 系统 | 灵魄类加成 |
| :----: | :---- |
| 装备系统 | 武器、护手改造的伤害强化、致命一击，所有部位改造的四象之力 |
| 灵魄系统 | 攻击灵魄的基础百分比加成 |
| 奥义系统 | 奥义资质百分比，灼伤，灭器，飞翎游侠的静神之意 |
| 子女系统 | 子女协力加的奋迅/妖法，雏凤 |
| 灵兽八阵图系统 | 灵兽物伤增强、法伤增强、强力 |
| 其他 | 佑弦一意的对怪加成 |

| 系统 | 灵魄类减伤 |
| :----: | :---- |
| 装备系统 | 头部、上装、下装改造的物防强化、魔防强化、禁卫、仙法，所有部位改造的四象之盾 |
| 灵魄系统 | 防御灵魄的基础百分比减伤 |
| 奥义系统 | 奥义资质百分比 |
| 子女系统 | 子女协力加的禁卫/仙法，苦修，浑天牢，冰魄盾，三昧甲，玄黄胄 |
| 灵兽八阵图系统 | 灵兽物伤减免、法伤减免、庇护、求生 |
| 其他 | 不灭金身的减伤 |

抗性类加成/减伤的来源见下表；

| 系统 | 抗性类加成 |
| :----: | :---- |
| 角色属性 | 奋迅、妖法的加点值 |
| 装备系统 | 武器、护手加的奋迅，护手强化等级 |
| 灵魄系统 | 奋迅之灵、妖法之灵 |
| 经络系统 | 经络孔位加的抗性，经络图谱加的抗性 |

| 系统 | 抗性类减伤 |
| :----: | :---- |
| 角色属性 | 禁卫、仙法的加点值 |
| 装备系统 | 上装加的禁卫，头部强化等级 |
| 灵魄系统 | 禁卫之灵、仙法之灵 |
| 经络系统 | 经络孔位加的抗性，经络图谱加的抗性 |

怪物的抗性类加成/减伤是怪物的内置属性，不同的怪物有不同的抗性类加成/减伤，见[原始解包数据](原始解包数据.md)中怪物数据表的BM-BP列。

### 元神加成/减伤

目前没有观察到元神评价压制有效果的证据。

怪物的元神加成/减伤是怪物的内置属性，不同的怪物有不同的元神加成/减伤，见[原始解包数据](原始解包数据.md)中怪物数据表的DI-DL列。

### 八阵图四象减伤

当攻方八阵图四象攻击克制目标八阵图四象防御时，
$$目标八阵图四象减伤=目标八阵图四象减伤面板值*50\%$$

### 对怪特殊加成

对怪特殊加成是怪物的内置属性，不同职业的玩家对不同的怪物有不同的对怪特殊加成，见[原始解包数据](原始解包数据.md)中怪物数据表的CB-CF列。

### 各职业被动心法

各职业的被动心法有加成、减伤、额外伤害、伤害抵消等效果，见[心法数据表](心法数据表.md)。

### 其他

$$攻方普通加成修正 \approx 0$$
$$三板斧额外伤害 = min(攻方最大血量, 140000) * 三板斧血量百分比$$
$$攻方普通加成修正 < 0.01\%$$
$$元神加成额外伤害 \approx 500$$
$$连击加成 = 0.005 * min(连击数, 200)$$

## 破甲与减破

破甲与减破是对攻击目标的防御值的改变。QQ三国的战斗系统中存在多种破甲与减破数值。

定义**破甲/减破百分比**为某种破甲/减破效果所增减的防御百分比。

定义**破甲/减破上限**为某种破甲/减破效果最大能增减的防御值。物防和法防的破甲/减破上限可能不一样。

定义**破甲/减破值**为某种破甲/减破效果所增减的防御值。

常见破甲效果的数值设定见[这里](常见破甲数据表.md)。

### 当目标为玩家时

定义**普通减破**为奥义护体之神、子女藤甲和120级技能减破的减破效果。

定义**坚韧减破**为坚韧之灵的减破效果。

定义**韧性减破**为角色韧性带来的减破效果。

定义**夫妻减破**为15级及以上夫妻触发协助防御时的减破效果。

韧性减破的数值设定见[这里](韧性减破数据表.md)。

夫妻减破的数值设定见[这里](夫妻减破数据表.md)。

当玩家有破甲与减破效果时，首先对每一种破甲效果计算破甲值
$$破甲值=\min((总防御-元神防御-八阵图防御)*破甲百分比*(1-普通减破百分比之和-\max(坚韧减破百分比-攻方突袭百分比,0)),破甲上限)$$
然后求和得到总破甲值
$$总破甲值=\sum_{不同破甲效果}破甲值$$
然后对韧性减破计算减破值
$$韧性减破值=\min((总防御-元神防御-八阵图防御)*韧性减破百分比,韧性减破上限)$$
再计算夫妻减破值（若有夫妻协助防御状态）
$$夫妻减破值=\min((总防御-元神防御-八阵图防御)*夫妻减破百分比*(1-普通减破百分比之和-\max(坚韧减破百分比-攻方突袭百分比,0)),夫妻减破上限)$$
最后得到目标经破甲与减破之后的防御值
$$防御=原防御*(1-破体之气忽略防御百分比)-(总破甲值-韧性减破值-夫妻减破值)$$

常见破甲效果中，虎虎生威与破军之气的破甲不能叠加，覆盖情况视破军之气的等级而定；天狼爪与八阵图青龙破甲不能叠加，覆盖情况视两者等级而定；YY100技能破甲与元神破甲不能叠加，元神破甲状态会覆盖YY100技能破甲状态。

[这里][破甲减破计算器]是一个计算破甲减破效果的小工具。

### 当目标为怪物时

当怪物有破甲与减破效果时，破甲/减破没有上限值，即
$$防御=原防御*(1-破体之气忽略防御百分比)*(1-破甲百分比之和*(1-减破百分比之和))$$
其中减破来自怪物的减破状态，如逍遥津138boss、河伯等怪物有减破状态。突袭之灵对怪物的减破无效。

## 刮骨

刮骨为玩家武器的一种改造效果，效果为每次攻击有15%的概率使目标获得降低武力、智力、体质、命中和灵活的状态，状态持续7秒。刮骨的属性降低效果包括固定降低点数和额外降低百分比，各级刮骨的固定降低点数和额外降低百分比见下表。

| 刮骨等级 | 固定降低点数 | 额外降低百分比 |
| :----: | :----: | :----: |
| +1 | 3 | 0% |
| +2 | 4 | 0.5% |
| +3 | 5 | 1% |
| +4 | 7 | 1.5% |
| +5 | 8 | 2% |
| +6 | 9 | 3% |
| +7 | 10 | 5.5% |
| +8 | 11 | 6.5% |
| +9 | 12 | 8% |

当目标为玩家时，受到刮骨后
$$属性=\max((原属性-固定降低点数)*(1-额外降低百分比), 30)$$
其中属性为武力、智力、体质、命中和灵活中的任意一项。

当目标为怪物时，额外降低百分比无效
$$属性=\max(原属性-固定降低点数, 30)$$
其中属性为武力、智力、体质、命中和灵活中的任意一项。

## 治疗结算与治疗量计算

治疗指任意形式的血量回复，分普通治疗、百分比治疗、固定治疗与吸血四类。

普通治疗指XS治疗技能和子女清晖洒、广寒力的治疗。百分比治疗指按最大生命值的一定百分比进行回复的治疗，包括YX心法、复苏之灵、关羽忠心不二回血、桂魄泉、长生灵兽的复苏、万物复苏、枯木逢春以及120技能回血等等。固定治疗指按固定生命值进行回复的治疗，包括某些再生状态、使用红药等等。吸血指根据攻击伤害的一定百分比进行回复的治疗，包括武器高吸、元神嗜血、奥义吸血、子女借势、灵兽化雨、经络图谱吸血效果、YX45技能、XS120技能吸血效果等等。

普通治疗的治疗量可看作一种特殊的伤害，其计算公式为
$$基础治疗量=0.5*(攻方智力-45)*(1+攻方法攻/24)*技能系数+技能攻击力$$
$$治疗量=基础治疗量*(1+攻方治疗量加成+目标受治疗量加成)*(1-目标受治疗量降低)+额外固定治疗量$$

注意，对子女而言，计算治疗量时，公式中的$攻方智力=子女面板智力+30$。

XS治疗技能的技能系数与0级技能攻击力见[这里](XS治疗技能技能系数与技能攻击力表.md)。子女清晖洒和广寒力的技能系数与技能攻击力见[子女主动技能数据表](子女主动技能数据表.md)。

攻方治疗量加成的来源见下表。

| 系统 | 治疗量加成来源 |
| :----: | :---- |
| 灵魄系统 | 光明之灵 |
| 元神系统 | 马超风扇，陆逊浩然，大乔春风 |
| 奥义系统 | 医圣加持，调养绵绵 |
| 子女系统 | 结丹 |
| 灵兽八阵图系统 | 治愈属性，向善变异，扶风，高级扶风，灵犀磅礴，八阵图玄武特技 |
| 经络系统 | 鹿奔4层，灵鹿1层，白鹿3层 |

目标受治疗量加成的来源见下表。

| 系统 | 受治疗量加成来源 |
| :----: | :---- |
| 灵魄系统 | 赐福之灵 |
| 元神系统 | 大乔国色 |
| 奥义系统 | 妙手之愈 |
| 子女系统 | 良方 |
| 其他 | 青梅状态，某些boss的技能等 |

目标受治疗量降低的来源见下表。

| 系统 | 受治疗量降低来源 |
| :----: | :---- |
| 灵魄系统 | 减治疗灵性 |
| 灵兽八阵图系统 | 灵咒 |
| 角色技能 | YX20，JS130，XS140 |
| 其他 | 某些boss的技能等 |

额外固定治疗量的来源见下表。

| 系统 | 额外固定治疗量来源 |
| :----: | :---- |
| 灵魄系统 | 天赐之灵 |

百分比治疗和吸血的治疗量可由相应的描述直接得到，且不受治疗量加成和治疗量降低的影响。

固定治疗的基础治疗量也可由相应的描述直接得到，而最终治疗量受目标受治疗量降低的影响，即
$$治疗量=基础治疗量*(1-目标受治疗量降低)$$

[破甲减破计算器]: https://www.qqsganalysis.cn/apps/实用计算器/破甲减破计算器

## 分析与讨论

- 破防点

    由修正因子的公式知，$约化防御<651$时伤害有明显提升，因此定义**破防点**为满足$约化防御=651$的攻击值。破防点由目标防御值和体质/智力决定
    $$物攻破防点=\frac{1}{2}\left[目标物防+(目标体质-30)*3-651\right]+450$$
    $$法攻破防点=\frac{1}{2}\left[目标法防+(目标智力-30)*3-651\right]+450$$

- 打怪中刮骨对伤害的提升的估算

    按刮骨+9算，刮骨+9的基础是减12点属性，那么

  1. 假设刚好破防，那么出刮骨带来的伤害提升百分比约为$(1-\frac{651-12*3}{768})/(1-\frac{651}{768})-1=31\%$
  2. 假设物攻高于破防点60点，那么出刮骨带来的伤害提升百分比约为$(1-\frac{651-60*2-12*3}{768})/(1-\frac{651-60*2}{768})-1=15\%$
  3. 假设物攻高于破防点120点，那么出刮骨带来的伤害提升百分比约为$(1-\frac{651-120*2-12*3}{768})/(1-\frac{651-120*2}{768})-1=10\%$
  4. 假设物攻低于破防点30点，那么出刮骨带来的伤害提升百分比约为$(651+30*2)^{0.9}/(651+30*2-12*3)^{0.9}-1=4.8\%$
  5. 假设物攻低于破防点60点，那么出刮骨带来的伤害提升百分比约为$(651+60*2)^{0.9}/(651+60*2-12*3)^{0.9}-1=4.4\%$
  6. 假设物攻低于破防点120点，那么出刮骨带来的伤害提升百分比约为$(651+120*2)^{0.9}/(651+120*2-12*3)^{0.9}-1=3.8\%$

- 破甲对伤害的提升的估算

    先计算一定破甲条件下的约化防御和对应的修正因子，再计算另一破甲条件下的约化防御和对应的修正因子，求两种条件下修正因子的比值即可估算得到伤害提升幅度。
    > 例：1398法攻的带满级8%破体之气的法系角色，攻击武圣单骑中的夏侯恩boss，单出元神破甲跟无任何破甲时相比，伤害提升多少？
    >
    > 解：查表知，武圣单骑中的夏侯恩boss的法防为541*6，智力为1+30，则
    > $$破甲前约化法防=541*6*0.92+1*3-(1398-450)*2=1093$$
    > $$破甲后约化法防=541*6*0.92*0.8+1*3-(1398-450)*2=496$$
    > $$破甲前后修正因子的比值=(1-\frac{496}{768})/\frac{51.5}{1093^{0.9}}=3.76$$
    > 所以单出元神破甲时的伤害是无任何破甲时的3.76倍。

- 额外伤害

    所有额外伤害，对人时都是对怪时的$\frac{1}{4}$。如三板斧最终伤害为
    $$对怪三板斧最终伤害=min(攻方最大血量, 140000)*三板斧血量百分比*(1+攻方元神加成-目标元神减伤)*(1+对怪特殊加成)*(1+连击加成)$$
    $$对人三板斧最终伤害=\frac{1}{4}min(攻方最大血量, 140000)*三板斧血量百分比*(1+攻方元神加成-目标元神减伤)*(1+攻方八阵图四象加成-目标八阵图四象减伤)*(1+连击加成)$$
