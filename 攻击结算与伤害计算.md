# 攻击结算与伤害计算

## 攻击结算

**技能**泛指游戏中能产生攻击、防御、辅助等战斗效果的主动操作。按技能使用者的类别分，技能可分为**玩家技能**和**怪物技能**。按所在系统分，玩家技能可分为**职业技能**、**元神技能**、**奥义技能**、**子女技能**、**灵兽技能**和**经络技能**。按伤害类型分，技能可分为**普通伤害技能**、**百分比伤害技能**和**固定伤害技能**。

定义**一次攻击**为一方向另一方发起的在同一时间内造成一个或多个技能的伤害的行为，并称攻击发起方为**攻方**，受到攻击的一方为**目标**。上述定义中的关键点为“同一时间内”，如130JS技能有先后的两段伤害，应看作两次攻击。按攻方和目标类别分，**一次攻击**可分为玩家攻击玩家、玩家攻击怪物、怪物攻击玩家、怪物攻击怪物四种情形。

目前我们暂时只考虑玩家攻击玩家和玩家攻击怪物两种情形，即只考虑玩家技能。

一次攻击的发起有且仅有三种情况：玩家施放职业技能、元神主动攻击技能或奥义技能；触发元神反击类技能或经络反击类技能（黑熊探掌）；子女施放攻击技能。定义**主技能**为发起攻击的技能。

当主技能非子女攻击技能时，一次攻击的结算流程如下。

> - 结算经络灵兽技能
>   - 判定经络技能和灵兽技能的触发
>     - 若主技能为元神反击类技能或经络反击类技能，则不触发经络技能
>   - 计算经络灵兽技能总伤害，相应扣除目标血量，并显示总伤害数字
>   - 计算吸血值：$$吸血值=(经络灵兽最终伤害-破空伤害)*吸血百分比$$相应增加攻方血量，并显示吸血数字
>   - 结算荆棘
>     - 若不是致死伤害：$$荆棘伤害=(经络灵兽最终伤害-破空伤害)*(荆棘反伤百分比之和-荆棘抵抗百分比之和)$$相应扣除攻方血量，并显示伤害数字
>     - 若是致死伤害：$$荆棘伤害=0$$
>
> - 结算元神乱舞类技能
>   - 判定元神乱舞类技能的触发
>     - 若触发了经络技能，则不触发元神乱舞类技能
>   - 计算元神乱舞类技能伤害，相应扣除目标血量，并显示伤害数字
>   - 计算吸血值：$$吸血值=(元神乱舞类技能最终伤害-破空伤害)*吸血百分比$$相应增加攻方血量，并显示吸血数字
>   - 结算荆棘
>     - 若不是致死伤害：$$荆棘伤害=(元神乱舞类技能最终伤害-破空伤害)*(荆棘反伤百分比之和-荆棘抵抗百分比之和)$$相应扣除攻方血量，并显示伤害数字
>     - 若是致死伤害：$$荆棘伤害=0$$
>
> - 结算主技能伤害
>   - 计算主技能伤害，相应扣除目标血量，并显示伤害数字
>   - 计算吸血值：$$吸血值=(主技能最终伤害-破空伤害)*吸血百分比$$相应增加攻方血量，并显示吸血数字
>   - 结算荆棘
>     - 若不是致死伤害：$$荆棘伤害=(主技能最终伤害-破空伤害)*(荆棘反伤百分比之和-荆棘抵抗百分比之和)$$相应扣除攻方血量，并显示伤害数字
>     - 若是致死伤害：$$荆棘伤害=0$$
>
> - 结算新增状态

## 普通伤害技能伤害计算

攻击结算中，无论是职业技能、元神技能、奥义技能、子女技能、灵兽技能还是经络技能，普通伤害技能伤害的计算均按照下述公式进行。

$$
\begin{aligned}
对人伤害 = & \max((((基础伤害 * \max((1 + 100\%暴击加成) * (1 + 攻方灵魄开灵暴击加成 + 攻方奥义痛击暴击加成 + 攻方狂战豪杰奥义狂暴之力暴击加成 - 目标灵魄开灵暴击减伤 - 目标奥义减暴护体暴击减伤), 1) \\
        & * (1 + 攻方灵魄类加成 - 目标灵魄类减伤 + 攻方抗性类加成 - 目标抗性类减伤 + 攻方普通加成修正 - 目标普通加成修正) + 500 * (攻方抗性类加成 - 目标抗性类减伤) + 杀戮额外伤害 + 三板斧额外伤害 + 被动心法额外伤害 - 被动心法伤害抵消) \\
        & * (1 + 攻方元神加成 * 攻方元神忠诚效果 - 目标元神减伤 * 目标元神忠诚效果 - 元神评价压制值 / 2 + 攻方元神加成修正 - 目标元神加成修正) + 500 * (攻方元神加成 * 攻方元神忠诚效果 - 目标元神减伤 * 目标元神忠诚效果)) \\
        & * (1 + 攻方八阵图四象加成 - 目标八阵图四象减伤) * (1 - 目标护体石减伤) + 攻方装备额外伤害 - 目标装备伤害抵消) \\
        & * (1 + 连击加成 * (1 + 攻方疾风剑侍快斩之意加成)) * (1 + 攻方夫妻加成) * (1 - 目标夫妻减伤) * (1 + 120技能对80技能的加成) * (1 - 形若坚冰减伤) * (1 - 卫心减伤) * \frac{1}{4}, 0) + 攻方破空额外伤害 + 攻方灵兽冲击属性额外伤害 + 1到5
\end{aligned}
$$

$$
\begin{aligned}
对怪伤害 = & \max((((基础伤害 * \max((1 + 100\%暴击加成) * (1 + 攻方灵魄开灵暴击加成 + 攻方奥义痛击暴击加成 + 攻方狂战豪杰奥义狂暴之力暴击加成), 1) \\
        & * (1 + 攻方灵魄类加成 + 攻方抗性类加成 - 目标抗性类减伤 + 攻方普通加成修正) + 500 * (攻方抗性类加成 - 目标抗性类减伤) + 杀戮额外伤害 + 三板斧额外伤害 + 被动心法额外伤害) \\
        & * (1 + 攻方元神加成 * 攻方元神忠诚效果 - 目标元神减伤 + 攻方元神加成修正) + 500 * (攻方元神加成 * 攻方元神忠诚效果 - 目标元神减伤)) \\
        & * (1 + 对怪特殊加成) + 攻方装备额外伤害) \\
        & * (1 + 连击加成 * (1 + 疾风剑侍快斩之意加成)) * (1 + 攻方夫妻加成) * (1 + 120技能对80技能的加成), 0) + 攻方破空额外伤害 + 攻方灵兽冲击属性额外伤害 + 1到5
\end{aligned}
$$

### 基础伤害

定义**约化物防**和**约化法防**为
$$
约化物防 =
\begin{cases}
    目标物防+(目标体质-30)*3 \qquad & 攻方物攻<450 \\
    目标物防+(目标体质-30)*3-(攻方物攻-450)*2 \qquad & 攻方物攻\geq450
\end{cases}
$$
$$
约化法防 =
\begin{cases}
    目标法防+(目标智力-30)*3 \qquad & 攻方法攻<450 \\
    目标法防+(目标智力-30)*3-(攻方法攻-450)*2 \qquad & 攻方法攻\geq450
\end{cases}
$$
其中目标物防和目标法防受到破甲与减破的影响，具体计算见[破甲与减破](#破甲与减破)一节；目标体质和目标智力受到刮骨的影响，见[刮骨](#刮骨)一节。

约化物防和约化法防统称约化防御。

当技能为物理伤害技能时，
$$基础伤害=(技能系数*系数伤害+技能攻击力+附加伤害)*修正因子$$
其中
$$系数伤害=A*(1+攻方物攻/B)*(攻方武力-D)$$
$$
附加伤害=
\begin{cases}
    A \qquad & 攻方物攻<目标物防/2\ 且\ 攻方物攻<450 \\
    C(1+D*攻方物攻-E*目标物防+F*攻方物攻*目标物防)*(攻方武力-G)-B \qquad & 目标物防/2 \leq 攻方物攻 < 450 \\
    C(1+D*攻方物攻-E*目标物防+F*攻方物攻*目标物防)*(攻方武力-G) \qquad & 攻方物攻\geq450
\end{cases}
$$
$$
修正因子 =
\begin{cases}
    1-\frac{约化物防}{768} \qquad & 约化物防<651 \\
    \frac{51.5}{约化物防^{0.9}} \qquad & 约化物防\geq651
\end{cases}
$$

当技能为法术伤害技能时，
$$基础伤害=(技能系数*系数伤害+技能攻击力)*修正因子+附加伤害$$
其中
$$
系数伤害 =
\begin{cases}
    (A+B*攻方法攻-C*目标法防+D*攻方法攻*目标法防)^2*(E+F*攻方智力) \qquad & 攻方法攻<450 \\
    (G+H*攻方法攻)*(K+L*攻方智力) \qquad & 攻方法攻\geq450
\end{cases}
$$
$$附加伤害=-目标法防/3$$
$$
修正因子 =
\begin{cases}
    1-\frac{约化法防}{768} \qquad & 约化法防<651 \\
    \frac{51.5}{约化法防^{0.9}} \qquad & 约化法防\geq651
\end{cases}
$$

物系职业也能释放法术伤害技能，法系职业也能释放物理伤害技能，但伤害一般都很低。一个技能是物理伤害技能还是法术伤害技能，可参考[原始解包数据](原始解包数据.md)中技能数据表的F列，相应的解读方式见[部分数据含义解读](原始解包数据.md#技能数据skilldatatxt（分析者：wu-yafeng，见issue10）)。

各技能的技能系数见[原始解包数据](原始解包数据.md)中技能数据表的AX列。怪物的物攻、法攻、物防、法防、武力、智力、命中、灵活和体质是怪物的内置属性，见[原始解包数据](原始解包数据.md)中怪物数据表的L-P列和U-X列。

自0.0.3.100(20220726)版本以来，解包数据中所有技能的技能系数均被隐藏。后续版本中，部分技能的技能系数和技能攻击力有改动，新增技能的技能系数和技能攻击力无法查看，均只能通过测试得到。现将自数据被隐藏以来有改动的技能以及新增技能的技能系数与技能攻击力列于[普通伤害技能技能系数与技能攻击力表](tables/普通伤害技能技能系数与技能攻击力表.md)。未在表中列出的技能可能未被改动，其数据可参考[原始解包数据](原始解包数据.md)中技能数据表的旧版本sheets。

### 普通加成

定义**普通加成**为灵魄类加成/减伤和抗性类加成/减伤的统称。

对于灵魄类加成/减伤：

$$
攻方灵魄类加成 = 攻方伤害增加 + 目标受伤增加
$$

$$
目标灵魄类减伤 = 攻方伤害降低 + 目标受伤降低
$$
其中
$$
\begin{aligned}
    攻方伤害增加 = & 攻方武器护手改造伤害强化 + 攻方武器护手改造四象之力 + 攻方致命一击加成 \\
        & + 攻方攻击灵魄的物理/法术伤害基础加成之和 \\
        & + 攻方奥义物攻/法攻资质百分比 + 攻方奥义灼伤 + 攻方奥义灭器 + 攻方奥义连环剑击 + 攻方飞翎游侠静神之意 \\
        & + 攻方子女协力加的奋迅/妖法 + 攻方子女雏凤 \\
        & + 攻方灵兽物伤/法伤增强 + 攻方灵兽强力属性 + 攻方灵兽重击属性 + 攻方灵兽嗜血技能伤害增加 + 攻方灵兽裂骨技能伤害增加 \\
        & + 攻方游侠佑弦一意的对怪加成 \\
        & + 以上未包含的一级分类码为15的伤害增加状态
\end{aligned}
$$

$$
\begin{aligned}
    目标受伤增加 = & 目标所受子女勘破 \\
        & + 目标灵兽嗜血技能受伤增加 + 目标所受灵兽无情撕咬技能受伤增加 \\
        & + 以上未包含的一级分类码为25的受伤增加状态
\end{aligned}
$$

$$
\begin{aligned}
    攻方伤害降低 = & 攻方所受子女强体 \\
        & 攻方所受日月如箭伤害降低 \\
        & + 以上未包含的一级分类码为15的伤害降低状态
\end{aligned}
$$

$$
\begin{aligned}
    目标受伤降低 = & 目标头部上装下装改造物防/魔防强化 + 目标头部上装下装鞋子四象之盾 + 目标上装改造禁卫/仙法概率减伤 \\
        & + 目标防御灵魄的物理/法术伤害基础减伤之和 \\
        & + 目标奥义物防/法防资质百分比 \\
        & + 目标子女协力加的禁卫/仙法 + 目标子女苦修 + 目标子女浑天牢 + 目标子女冰魄盾 + 目标子女三昧甲 + 目标子女玄黄胄 \\
        & + 目标灵兽物伤/法伤减免 + 目标灵兽求生属性 + 目标灵兽庇护属性 \\
        & + 目标豪杰不灭金身减伤 \\
        & + 以上未包含的一级分类码为25的受伤降低状态
\end{aligned}
$$

对于抗性类加成/减伤：

$$
\begin{aligned}
    攻方抗性类加成 = & 攻方角色奋迅/妖法加点值 \\
        & + 攻方武器护手打造属性加的奋迅/妖法 + 攻方护手强化等级 \\
        & + 攻方奋迅/妖法之灵加的奋迅/妖法 \\
        & + 攻方经络孔位加的奋迅/妖法 + 攻方经络图谱加的奋迅/妖法
\end{aligned}
$$

$$
\begin{aligned}
    目标抗性类减伤 = & 目标角色禁卫/仙法加点值 \\
        & + 目标上装打造属性加的禁卫 + 目标头部强化等级 \\
        & + 目标禁卫/仙法之灵加的禁卫/仙法 \\
        & + 攻方经络孔位加的禁卫/仙法 + 攻方经络图谱加的禁卫/仙法
\end{aligned}
$$

怪物的抗性类加成/减伤是怪物的内置属性，不同的怪物有不同的抗性类加成/减伤，见[原始解包数据](原始解包数据.md)中怪物数据表的BM-BP列。

### 元神加成/减伤

当目标无元神时，元神评价压制值=0；当目标有元神而攻方无元神时，元神评价压制值=15%；当双方均有元神时，若攻方元神评价比目标元神评价低5段及以上，元神评价压制值=15%；4段为12%；3段为9%；2段为6%；1段为3%；若攻方元神评价>=目标元神评价，元神评价压制值=0。

怪物的元神加成/减伤是怪物的内置属性，不同的怪物有不同的元神加成/减伤，见[原始解包数据](原始解包数据.md)中怪物数据表的DI-DL列。

### 八阵图四象减伤

当攻方八阵图四象攻击克制目标八阵图四象防御时，
$$目标八阵图四象减伤=目标八阵图四象减伤面板值*50\%$$

### 对怪特殊加成

对怪特殊加成是怪物的内置属性，不同职业的玩家对不同的怪物有不同的对怪特殊加成，见[原始解包数据](原始解包数据.md)中怪物数据表的CB-CF列。

### 各职业被动心法

各职业的被动心法有加成、减伤、额外伤害、伤害抵消等效果，见[心法数据表](tables/心法数据表.md)。

### 其他

$$攻方普通加成修正 \approx 0$$
$$三板斧额外伤害 = \min(攻方最大血量, 140000) * 三板斧血量百分比$$
$$攻方元神加成修正 < 0.01\%$$
$$连击加成 = 0.005 * min(连击数, 200)$$
$$攻方灵兽冲击属性额外伤害 = \min(目标当前血量, 150000) * 攻方灵兽冲击属性百分比$$

### 破甲与减破

破甲与减破是对攻击目标的防御值的改变。QQ三国的战斗系统中存在多种破甲与减破数值。

定义**破甲/减破百分比**为某种破甲/减破效果所增减的防御百分比。

定义**破甲/减破上限**为某种破甲/减破效果最大能增减的防御值。物防和法防的破甲/减破上限可能不一样。

定义**破甲/减破值**为某种破甲/减破效果所增减的防御值。

常见破甲效果的数值设定见[这里](tables/常见破甲数据表.md)。

#### 当目标为玩家时

定义**普通减破**为奥义护体之神、子女藤甲和120级技能减破的减破效果。

定义**坚韧减破**为坚韧之灵的减破效果。

定义**韧性减破**为角色韧性带来的减破效果。

定义**夫妻减破**为15级及以上夫妻触发协助防御时的减破效果。

韧性减破的数值设定见[这里](tables/韧性减破数据表.md)。

夫妻减破的数值设定见[这里](tables/夫妻减破数据表.md)。

当玩家有破甲与减破效果时，首先对每一种破甲效果计算破甲值
$$破甲值=\min((总防御-元神防御-八阵图防御)*破甲百分比*(1-普通减破百分比之和-\max(坚韧减破百分比-攻方突袭百分比,0)),破甲上限)$$
然后求和得到总破甲值
$$总破甲值=\sum_{不同破甲效果}破甲值$$
然后对韧性减破计算减破值
$$韧性减破值=\min((总防御-元神防御-八阵图防御)*韧性减破百分比,韧性减破上限)$$
再计算夫妻减破值（若有夫妻协助防御状态）
$$夫妻减破值=\min((总防御-元神防御-八阵图防御)*夫妻减破百分比*(1-普通减破百分比之和-\max(坚韧减破百分比-攻方突袭百分比,0)),夫妻减破上限)$$
最后得到目标经破甲与减破之后的防御值
$$防御=(原防御-(总破甲值-韧性减破值-夫妻减破值))*(1-破体之气忽略防御百分比)*(1-\max(攻方灵兽击破或穿透百分比-目标灵兽稳固或坚毅百分比, 0))$$

常见破甲效果中，虎虎生威与破军之气的破甲不能叠加，覆盖情况视破军之气的等级而定；天狼爪与八阵图青龙破甲不能叠加，覆盖情况视两者等级而定；YY100技能破甲与元神破甲不能叠加，元神破甲状态会覆盖YY100技能破甲状态。

[这里][破甲减破计算器]是一个计算破甲减破效果的小工具。

#### 当目标为怪物时

当怪物有破甲与减破效果时，破甲/减破没有上限值，即
$$防御=原防御*(1-破甲百分比之和*(1-减破百分比之和))*(1-破体之气忽略防御百分比)$$
其中减破来自怪物的减破状态，如逍遥津138boss、河伯等怪物有减破状态。突袭之灵对怪物的减破无效。

### 刮骨

刮骨为玩家武器的一种改造效果，效果为每次攻击有15%的概率使目标获得降低武力、智力、体质、命中和灵活的状态，状态持续7秒。刮骨的属性降低效果包括固定降低点数和额外降低百分比，各级刮骨的固定降低点数和额外降低百分比见下表。

| 刮骨等级 | 固定降低点数 | 额外降低百分比 |
| :------: | :----------: | :------------: |
|    +1    |      3       |       0%       |
|    +2    |      4       |      0.5%      |
|    +3    |      5       |       1%       |
|    +4    |      7       |      1.5%      |
|    +5    |      8       |       2%       |
|    +6    |      9       |       3%       |
|    +7    |      10      |      5.5%      |
|    +8    |      11      |      6.5%      |
|    +9    |      12      |       8%       |

当目标为玩家时，受到刮骨后
$$属性=\max((原属性-固定降低点数)*(1-额外降低百分比), 30)$$
其中属性为武力、智力、体质、命中和灵活中的任意一项。

当目标为怪物时，额外降低百分比无效
$$属性=\max(原属性-固定降低点数, 30)$$
其中属性为武力、智力、体质、命中和灵活中的任意一项。

[破甲减破计算器]: http://101.37.31.0/apps/实用计算器/破甲减破计算器

## 百分比伤害技能和固定伤害技能伤害计算

在玩家技能中，百分比伤害技能仅有：XS90技能、XS110技能、灵兽蛮力冲撞、灵兽吞噬、灵兽闪击、灵兽高级闪击、灵兽舍身一搏，没有固定伤害技能。在怪物技能中，存在许多百分比伤害技能和固定伤害技能。

一般来说，百分比伤害技能的伤害计算方式为
$$百分比伤害技能伤害=\min(目标当前或最大血量 * 百分比, 伤害上限)$$

固定伤害技能的伤害为固定值。

百分比伤害技能的百分比和伤害上限以及固定伤害技能的伤害见[百分比伤害技能和固定伤害技能数据表](tables/百分比伤害技能和固定伤害技能数据表.md)。

灵兽闪击与高级闪击技能的伤害计算方式略有不同，为
$$闪击或高级闪击技能伤害=\frac{目标当前血量}{目标最大血量}*\min(目标最大血量, 180000)*闪击或高级闪击百分比$$
注意，$上式 \leq \min(目标当前血量, 180000) * 闪击或高级闪击百分比$。

## 分析与讨论

- 破防点

    由修正因子的公式知，$约化防御<651$时伤害有明显提升，因此定义**破防点**为满足$约化防御=651$的攻击值。破防点由目标防御值和体质/智力决定
    $$物攻破防点=\frac{1}{2}\left[目标物防+(目标体质-30)*3-651\right]+450$$
    $$法攻破防点=\frac{1}{2}\left[目标法防+(目标智力-30)*3-651\right]+450$$

- 打怪中刮骨对伤害的提升的估算

    按刮骨+9算，刮骨+9的基础是减12点属性，那么

  1. 假设刚好破防，那么出刮骨带来的伤害提升百分比约为$(1-\frac{651-12*3}{768})/(1-\frac{651}{768})-1=31\%$
  2. 假设物攻高于破防点60点，那么出刮骨带来的伤害提升百分比约为$(1-\frac{651-60*2-12*3}{768})/(1-\frac{651-60*2}{768})-1=15\%$
  3. 假设物攻高于破防点120点，那么出刮骨带来的伤害提升百分比约为$(1-\frac{651-120*2-12*3}{768})/(1-\frac{651-120*2}{768})-1=10\%$
  4. 假设物攻低于破防点30点，那么出刮骨带来的伤害提升百分比约为$(651+30*2)^{0.9}/(651+30*2-12*3)^{0.9}-1=4.8\%$
  5. 假设物攻低于破防点60点，那么出刮骨带来的伤害提升百分比约为$(651+60*2)^{0.9}/(651+60*2-12*3)^{0.9}-1=4.4\%$
  6. 假设物攻低于破防点120点，那么出刮骨带来的伤害提升百分比约为$(651+120*2)^{0.9}/(651+120*2-12*3)^{0.9}-1=3.8\%$

- 破甲对伤害的提升的估算

    先计算一定破甲条件下的约化防御和对应的修正因子，再计算另一破甲条件下的约化防御和对应的修正因子，求两种条件下修正因子的比值即可估算得到伤害提升幅度。
    > 例：1398法攻的带满级8%破体之气的法系角色，攻击武圣单骑中的夏侯恩boss，单出元神破甲跟无任何破甲时相比，伤害提升多少？
    >
    > 解：查表知，武圣单骑中的夏侯恩boss的法防为541*6，智力为1+30，则
    > $$破甲前约化法防=541*6*0.92+1*3-(1398-450)*2=1093$$
    > $$破甲后约化法防=541*6*0.92*0.8+1*3-(1398-450)*2=496$$
    > $$破甲前后修正因子的比值=(1-\frac{496}{768})/\frac{51.5}{1093^{0.9}}=3.76$$
    > 所以单出元神破甲时的伤害是无任何破甲时的3.76倍。

- 额外伤害

    除破空和灵兽冲击属性以外的额外伤害，对人时都是对怪时的$\frac{1}{4}$。如三板斧最终伤害为
    $$对怪三板斧最终伤害=\min(攻方最大血量, 140000)*三板斧血量百分比*(1+攻方元神加成-目标元神减伤)*(1+对怪特殊加成)*(1+连击加成)$$
    $$对人三板斧最终伤害=\frac{1}{4}\min(攻方最大血量, 140000)*三板斧血量百分比*(1+攻方元神加成-目标元神减伤)*(1+攻方八阵图四象加成-目标八阵图四象减伤)*(1+连击加成)$$
